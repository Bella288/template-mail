<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Template Builder</title>
    <!-- Add EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7f9;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }
        
        .sidebar h2 {
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 1px solid #4a6278;
            padding-bottom: 10px;
        }
        
        .components-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .component-item {
            background-color: #34495e;
            padding: 12px;
            border-radius: 5px;
            cursor: grab;
            transition: all 0.2s;
        }
        
        .component-item:hover {
            background-color: #4a6278;
            transform: translateY(-2px);
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            background-color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #ecf0f1;
            color: #2c3e50;
        }
        
        .btn-secondary:hover {
            background-color: #dfe6e9;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .editor-area {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Canvas Styles */
        .canvas-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .canvas-header {
            margin-bottom: 20px;
        }
        
        #email-canvas {
            background-color: white;
            border: 1px dashed #ddd;
            min-height: 500px;
            padding: 20px;
            border-radius: 5px;
        }
        
        .canvas-placeholder {
            text-align: center;
            color: #95a5a6;
            padding: 40px;
        }
        
        .email-component {
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .email-component:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .component-content {
            padding: 15px;
        }
        
        .component-tools {
            display: flex;
            background-color: #f9f9f9;
            padding: 8px;
            border-top: 1px solid #e0e0e0;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .edit-btn, .delete-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .edit-btn {
            background-color: #3498db;
            color: white;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        /* Property Editor Styles */
        .property-editor {
            width: 350px;
            background-color: white;
            border-left: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }
        
        .property-editor h2 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .property-group {
            margin-bottom: 25px;
        }
        
        .property-group h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input[type="text"],
        .form-group textarea,
        .form-group input[type="color"],
        .form-group input[type="email"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .variable-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        
        .variable-chip {
            background-color: #e8f4fc;
            color: #3498db;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .variable-chip:hover {
            background-color: #d1ebff;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #95a5a6;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Preview Modal Specific */
        #preview-content {
            border: 1px solid #eee;
            padding: 20px;
            background-color: white;
        }
        
        /* Export Modal Specific */
        .export-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        #export-code-container {
            display: none;
            margin-top: 20px;
        }
        
        #export-code {
            background-color: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Variables Modal Specific */
        .variables-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Send Email Modal Specific */
        .send-email-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Toast Notification */
        #toast {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        /* Status indicators */
        .status-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 992px) {
            .editor-area {
                flex-direction: column;
            }
            
            .property-editor {
                width: 100%;
                border-left: none;
                border-top: 1px solid #e0e0e0;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .variables-form {
                grid-template-columns: 1fr;
            }
            
            .toolbar-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                justify-content: flex-end;
            }
            
            .modal-content {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar with components -->
        <div class="sidebar">
            <h2>Components</h2>
            <div class="components-list">
                <div class="component-item" draggable="true" data-type="header">
                    <strong>Header</strong>
                    <p>Email header with logo and navigation</p>
                </div>
                <div class="component-item" draggable="true" data-type="hero">
                    <strong>Hero Section</strong>
                    <p>Promotional banner area</p>
                </div>
                <div class="component-item" draggable="true" data-type="text">
                    <strong>Text Block</strong>
                    <p>Simple text content</p>
                </div>
                <div class="component-item" draggable="true" data-type="image">
                    <strong>Image</strong>
                    <p>Image with optional link</p>
                </div>
                <div class="component-item" draggable="true" data-type="button">
                    <strong>Button</strong>
                    <p>Call-to-action button</p>
                </div>
                <div class="component-item" draggable="true" data-type="footer">
                    <strong>Footer</strong>
                    <p>Email footer with contact info</p>
                </div>
            </div>
        </div>
        
        <!-- Main content area -->
        <div class="main-content">
            <!-- Toolbar -->
            <div class="toolbar">
                <h1>Email Template Builder</h1>
                <div class="toolbar-buttons">
                    <button id="variables-btn" class="btn btn-secondary">Variables</button>
                    <button id="preview-btn" class="btn btn-secondary">Preview</button>
                    <button id="send-btn" class="btn btn-success">Send Email</button>
                    <button id="export-btn" class="btn btn-primary">Export</button>
                </div>
            </div>
            
            <!-- Editor area with canvas and property editor -->
            <div class="editor-area">
                <!-- Canvas where components are placed -->
                <div class="canvas-container">
                    <div class="canvas-header">
                        <h2>Your Email Template</h2>
                        <p>Drag components from the sidebar to build your email</p>
                    </div>
                    <div id="email-canvas">
                        <div class="canvas-placeholder">
                            <p>Drag components from the left panel to build your email template</p>
                        </div>
                    </div>
                </div>
                
                <!-- Property editor panel -->
                <div class="property-editor" id="property-editor">
                    <h2>Properties</h2>
                    <p>Select a component to edit its properties</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="modal" id="preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Email Preview</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="preview-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary close-modal">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Export Email Template</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <button id="export-html" class="btn btn-primary">Generate HTML</button>
                    <button id="export-copy" class="btn btn-secondary">Copy to Clipboard</button>
                </div>
                <div id="export-code-container">
                    <h3>HTML Code:</h3>
                    <pre id="export-code"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary close-modal">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Variables Modal -->
    <div class="modal" id="variables-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Template Variables</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="variables-form">
                    <div class="form-group">
                        <label for="sender-name">Sender Name</label>
                        <input type="text" id="sender-name" placeholder="e.g., John Smith">
                    </div>
                    <div class="form-group">
                        <label for="sender-email">Sender Email</label>
                        <input type="text" id="sender-email" placeholder="e.g., john@example.com">
                    </div>
                    <div class="form-group">
                        <label for="recipient-name">Recipient Name</label>
                        <input type="text" id="recipient-name" placeholder="e.g., Jane Doe">
                    </div>
                    <div class="form-group">
                        <label for="recipient-email">Recipient Email</label>
                        <input type="text" id="recipient-email" placeholder="e.g., jane@example.com">
                    </div>
                    <div class="form-group">
                        <label for="send-date">Send Date</label>
                        <input type="date" id="send-date">
                    </div>
                    <div class="form-group">
                        <label for="company-name">Company Name</label>
                        <input type="text" id="company-name" placeholder="John Doe and Sons">
                    </div>
                </div>
                <div class="variable-info" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                    <h3>How to Use Variables</h3>
                    <p>Use these placeholders in your content:</p>
                    <ul style="margin-top: 10px; margin-left: 20px;">
                        <li><strong>{sName}</strong> - Sender Name</li>
                        <li><strong>{sEmail}</strong> - Sender Email</li>
                        <li><strong>{rName}</strong> - Recipient Name</li>
                        <li><strong>{rEmail}</strong> - Recipient Email</li>
                        <li><strong>{sDate}</strong> - Send Date</li>
                        <li><strong>{cName}</strong> - Company Name</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-variables" class="btn btn-primary">Save Variables</button>
                <button class="btn btn-secondary close-modal">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Send Email Modal -->
    <div class="modal" id="send-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Email</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="send-email-form">
                    <div class="form-group">
                        <label for="send-to">To</label>
                        <input type="email" id="send-to" placeholder="recipient@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="send-subject">Subject</label>
                        <input type="text" id="send-subject" placeholder="Email subject" required>
                    </div>
                    <div class="form-group">
                        <label for="send-from-name">From Name</label>
                        <input type="text" id="send-from-name" placeholder="Your Name">
                    </div>
                </div>
                <div id="send-status" style="margin-top: 15px; padding: 10px; display: none;"></div>
            </div>
            <div class="modal-footer">
                <button id="send-email-btn" class="btn btn-success">Send Now</button>
                <button class="btn btn-secondary close-modal">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast"></div>

    <script>
        // Initialize EmailJS with your public key
        // Replace 'YOUR_PUBLIC_KEY' with your actual EmailJS public key
        emailjs.init("FNNCmBtDRxLL0AE5S");
        
        // DOM Elements
        const emailCanvas = document.getElementById('email-canvas');
        const propertyEditor = document.getElementById('property-editor');
        const previewModal = document.getElementById('preview-modal');
        const exportModal = document.getElementById('export-modal');
        const variablesModal = document.getElementById('variables-modal');
        const sendModal = document.getElementById('send-modal');
        const previewContent = document.getElementById('preview-content');
        const exportCode = document.getElementById('export-code');
        const exportCodeContainer = document.getElementById('export-code-container');
        const toast = document.getElementById('toast');
        const sendStatus = document.getElementById('send-status');
        
        // Buttons
        const previewBtn = document.getElementById('preview-btn');
        const exportBtn = document.getElementById('export-btn');
        const sendBtn = document.getElementById('send-btn');
        const variablesBtn = document.getElementById('variables-btn');
        const saveVariablesBtn = document.getElementById('save-variables');
        const sendEmailBtn = document.getElementById('send-email-btn');
        
        // Variable Inputs
        const senderNameInput = document.getElementById('sender-name');
        const senderEmailInput = document.getElementById('sender-email');
        const recipientNameInput = document.getElementById('recipient-name');
        const recipientEmailInput = document.getElementById('recipient-email');
        const sendDateInput = document.getElementById('send-date');
        const companyNameInput = document.getElementById('company-name');
        
        // Send Email Inputs
        const sendToInput = document.getElementById('send-to');
        const sendSubjectInput = document.getElementById('send-subject');
        const sendFromNameInput = document.getElementById('send-from-name');
        
        // Close modal buttons
        const closeModalButtons = document.querySelectorAll('.close-modal');
        
        // Store components and variables
        let components = [];
        let variables = {
            senderName: '',
            senderEmail: '',
            recipientName: '',
            recipientEmail: '',
            sendDate: '',
            companyName: ''
        };
        
        // Variable mapping
        const variableMap = {
            '{sName}': 'senderName',
            '{sEmail}': 'senderEmail',
            '{rName}': 'recipientName',
            '{rEmail}': 'recipientEmail',
            '{sDate}': 'sendDate',
            '{cName}': 'companyName'
        };
        
        // Currently selected component for editing
        let currentlyEditingComponent = null;
        
        // Initialize the application
        function init() {
            // Set today's date as default for send date
            const today = new Date().toISOString().split('T')[0];
            sendDateInput.value = today;
            variables.sendDate = today;
            
            // Load saved variables from localStorage if available
            loadSavedVariables();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize the canvas
            checkEmptyCanvas();
        }
        
        // Load saved variables from localStorage
        function loadSavedVariables() {
            const savedVariables = localStorage.getItem('emailTemplateVariables');
            if (savedVariables) {
                const parsedVariables = JSON.parse(savedVariables);
                variables = {...variables, ...parsedVariables};
                
                // Update input fields
                senderNameInput.value = variables.senderName || '';
                senderEmailInput.value = variables.senderEmail || '';
                recipientNameInput.value = variables.recipientName || '';
                recipientEmailInput.value = variables.recipientEmail || '';
                sendDateInput.value = variables.sendDate || new Date().toISOString().split('T')[0];
                companyNameInput.value = variables.companyName || '';
                
                // Pre-fill send form with saved variables
                sendToInput.value = variables.recipientEmail || '';
                sendFromNameInput.value = variables.senderName || '';
            }
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // Drag and drop for components
            setupDragAndDrop();
            
            // Modal buttons
            previewBtn.addEventListener('click', showPreview);
            exportBtn.addEventListener('click', showExportModal);
            sendBtn.addEventListener('click', showSendModal);
            variablesBtn.addEventListener('click', showVariablesModal);
            saveVariablesBtn.addEventListener('click', saveVariables);
            sendEmailBtn.addEventListener('click', sendEmail);
            
            // Close modals
            closeModalButtons.forEach(button => {
                button.addEventListener('click', () => {
                    previewModal.style.display = 'none';
                    exportModal.style.display = 'none';
                    variablesModal.style.display = 'none';
                    sendModal.style.display = 'none';
                });
            });
            
            // Export options
            document.getElementById('export-html').addEventListener('click', exportAsHTML);
            document.getElementById('export-copy').addEventListener('click', copyToClipboard);
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === previewModal) previewModal.style.display = 'none';
                if (e.target === exportModal) exportModal.style.display = 'none';
                if (e.target === variablesModal) variablesModal.style.display = 'none';
                if (e.target === sendModal) sendModal.style.display = 'none';
            });
        }
        
        // Set up drag and drop functionality
        function setupDragAndDrop() {
            const componentItems = document.querySelectorAll('.component-item[draggable="true"]');
            
            componentItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.type);
                });
            });
            
            emailCanvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                emailCanvas.classList.add('drag-over');
            });
            
            emailCanvas.addEventListener('dragleave', () => {
                emailCanvas.classList.remove('drag-over');
            });
            
            emailCanvas.addEventListener('drop', (e) => {
                e.preventDefault();
                emailCanvas.classList.remove('drag-over');
                
                const componentType = e.dataTransfer.getData('text/plain');
                addComponentToCanvas(componentType);
            });
        }
        
        // Add a component to the canvas
        function addComponentToCanvas(type) {
            // Remove the placeholder if it exists
            const placeholder = emailCanvas.querySelector('.canvas-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
            
            let componentHtml = '';
            let defaultContent = '';
            
            switch (type) {
                case 'header':
                    defaultContent = '<div style="text-align: center; padding: 20px; background-color: #f8f9fa;"><h1>Email Header</h1><p>{cName}</p></div>';
                    break;
                case 'hero':
                    defaultContent = '<div style="text-align: center; padding: 40px; background-color: #e9ecef;"><h2>Hero Section</h2><p>Engaging content goes here</p><p>Use variables like {rName} to personalize</p></div>';
                    break;
                case 'text':
                    defaultContent = '<p>This is a text block from {cName}. You can edit this content to add your own text. Use variables like {rName} to personalize your message.</p>';
                    break;
                case 'image':
                    defaultContent = '<img src="https://via.placeholder.com/600x300" alt="Placeholder Image" style="max-width: 100%; height: auto;">';
                    break;
                case 'button':
                    defaultContent = '<div style="text-align: center; margin: 20px 0;"><a href="#" style="display: inline-block; padding: 12px 24px; background-color: #6e8efb; color: white; text-decoration: none; border-radius: 4px;">Click Me</a></div>';
                    break;
                case 'footer':
                    defaultContent = '<div style="text-align: center; padding: 20px; background-color: #f5f5f5; margin-top: 20px;"><p>&copy; 2023 {cName}. All rights reserved.</p><p>Contact: {sEmail}</p></div>';
                    break;
            }
            
            componentHtml = `
                <div class="component-content">${defaultContent}</div>
                <div class="component-tools">
                    <button class="edit-btn">Edit</button>
                    <button class="delete-btn">Delete</button>
                </div>
            `;
            
            const componentElement = document.createElement('div');
            componentElement.className = 'email-component';
            componentElement.setAttribute('data-type', type);
            componentElement.innerHTML = componentHtml;
            
            // Add event listeners for the tools
            const editBtn = componentElement.querySelector('.edit-btn');
            const deleteBtn = componentElement.querySelector('.delete-btn');
            
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showPropertyEditor(componentElement, type);
            });
            
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                componentElement.remove();
                updateComponentsArray();
                checkEmptyCanvas();
            });
            
            // Also make the whole component clickable for editing
            componentElement.addEventListener('click', (e) => {
                if (e.target === componentElement || e.target.classList.contains('component-content')) {
                    showPropertyEditor(componentElement, type);
                }
            });
            
            emailCanvas.appendChild(componentElement);
            updateComponentsArray();
        }
        
        // Show property editor for a component
        function showPropertyEditor(component, type) {
            currentlyEditingComponent = component;
            let editorHtml = '';
            
            switch (type) {
                case 'text':
                    const currentText = component.querySelector('.component-content').innerHTML;
                    editorHtml = `
                        <div class="property-group">
                            <h3>Text Content</h3>
                            <div class="form-group">
                                <label for="text-content">Text Content</label>
                                <textarea id="text-content" rows="6" placeholder="Enter your text here">${currentText}</textarea>
                            </div>
                            <div class="variable-palette">
                                <span class="variable-chip" data-var="{rName}">Recipient Name</span>
                                <span class="variable-chip" data-var="{sName}">Sender Name</span>
                                <span class="variable-chip" data-var="{sEmail}">Sender Email</span>
                                <span class="variable-chip" data-var="{rEmail}">Recipient Email</span>
                                <span class="variable-chip" data-var="{sDate}">Send Date</span>
                                <span class="variable-chip" data-var="{cName}">Company Name</span>
                            </div>
                            <button class="btn btn-primary" id="save-text">Save Changes</button>
                        </div>
                    `;
                    break;
                case 'image':
                    const currentSrc = component.querySelector('img')?.src || '';
                    const currentAlt = component.querySelector('img')?.alt || '';
                    const currentLink = component.querySelector('a')?.href || '';
                    editorHtml = `
                        <div class="property-group">
                            <h3>Image Properties</h3>
                            <div class="form-group">
                                <label for="image-src">Image URL</label>
                                <input type="text" id="image-src" value="${currentSrc}" placeholder="https://example.com/image.jpg">
                            </div>
                            <div class="form-group">
                                <label for="image-alt">Alt Text</label>
                                <input type="text" id="image-alt" value="${currentAlt}" placeholder="Description of image">
                            </div>
                            <div class="form-group">
                                <label for="image-link">Link URL (optional)</label>
                                <input type="text" id="image-link" value="${currentLink}" placeholder="https://example.com">
                            </div>
                            <button class="btn btn-primary" id="save-image">Save Changes</button>
                        </div>
                    `;
                    break;
                case 'button':
                    const currentButton = component.querySelector('a');
                    editorHtml = `
                        <div class="property-group">
                            <h3>Button Properties</h3>
                            <div class="form-group">
                                <label for="button-text">Button Text</label>
                                <input type="text" id="button-text" value="${currentButton.textContent}" placeholder="Button Text">
                            </div>
                            <div class="form-group">
                                <label for="button-link">Button Link</label>
                                <input type="text" id="button-link" value="${currentButton.href}" placeholder="https://example.com">
                            </div>
                            <div class="form-group">
                                <label for="button-color">Button Color</label>
                                <input type="color" id="button-color" value="${currentButton.style.backgroundColor || '#6e8efb'}">
                            </div>
                            <button class="btn btn-primary" id="save-button">Save Changes</button>
                        </div>
                    `;
                    break;
                case 'header':
                    const headerContent = component.querySelector('.component-content');
                    const headerTitle = headerContent.querySelector('h1')?.textContent || 'Email Header';
                    const headerSubtitle = headerContent.querySelector('p')?.textContent || '{cName}';
                    editorHtml = `
                        <div class="property-group">
                            <h3>Header Properties</h3>
                            <div class="form-group">
                                <label for="header-title">Header Title</label>
                                <input type="text" id="header-title" value="${headerTitle}" placeholder="Header Title">
                            </div>
                            <div class="form-group">
                                <label for="header-subtitle">Header Subtitle</label>
                                <input type="text" id="header-subtitle" value="${headerSubtitle}" placeholder="Header Subtitle">
                            </div>
                            <div class="variable-palette">
                                <span class="variable-chip" data-var="{rName}">Recipient Name</span>
                                <span class="variable-chip" data-var="{sName}">Sender Name</span>
                                <span class="variable-chip" data-var="{sEmail}">Sender Email</span>
                                <span class="variable-chip" data-var="{cName}">Company Name</span>
                            </div>
                            <button class="btn btn-primary" id="save-header">Save Changes</button>
                        </div>
                    `;
                    break;
                case 'hero':
                    const heroContent = component.querySelector('.component-content');
                    const heroTitle = heroContent.querySelector('h2')?.textContent || 'Hero Section';
                    const heroText = heroContent.querySelector('p')?.textContent || 'Engaging content goes here';
                    editorHtml = `
                        <div class="property-group">
                            <h3>Hero Section Properties</h3>
                            <div class="form-group">
                                <label for="hero-title">Hero Title</label>
                                <input type="text" id="hero-title" value="${heroTitle}" placeholder="Hero Title">
                            </div>
                            <div class="form-group">
                                <label for="hero-text">Hero Text</label>
                                <textarea id="hero-text" rows="3" placeholder="Hero text content">${heroText}</textarea>
                            </div>
                            <div class="variable-palette">
                                <span class="variable-chip" data-var="{rName}">Recipient Name</span>
                                <span class="variable-chip" data-var="{sName}">Sender Name</span>
                                <span class="variable-chip" data-var="{sDate}">Send Date</span>
                                <span class="variable-chip" data-var="{cName}">Company Name</span>
                            </div>
                            <button class="btn btn-primary" id="save-hero">Save Changes</button>
                        </div>
                    `;
                    break;
                case 'footer':
                    const footerContent = component.querySelector('.component-content');
                    const footerText = footerContent.querySelector('p')?.textContent || 'Â© 2023 {cName}. All rights reserved.';
                    const footerContact = footerContent.querySelectorAll('p')[1]?.textContent.replace('Contact: ', '') || '';
                    editorHtml = `
                        <div class="property-group">
                            <h3>Footer Properties</h3>
                            <div class="form-group">
                                <label for="footer-text">Footer Text</label>
                                <input type="text" id="footer-text" value="${footerText}" placeholder="Footer text">
                            </div>
                            <div class="form-group">
                                <label for="footer-contact">Contact Info</label>
                                <input type="text" id="footer-contact" value="${footerContact}" placeholder="Contact information">
                            </div>
                            <div class="variable-palette">
                                <span class="variable-chip" data-var="{sEmail}">Sender Email</span>
                                <span class="variable-chip" data-var="{sName}">Sender Name</span>
                                <span class="variable-chip" data-var="{sDate}">Send Date</span>
                                <span class="variable-chip" data-var="{cName}">Company Name</span>
                            </div>
                            <button class="btn btn-primary" id="save-footer">Save Changes</button>
                        </div>
                    `;
                    break;
                default:
                    editorHtml = `<p>No properties to edit for this component.</p>`;
            }
            
            propertyEditor.innerHTML = editorHtml;
            
            // Add event listeners to variable chips
            const variableChips = propertyEditor.querySelectorAll('.variable-chip');
            variableChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    const variable = chip.getAttribute('data-var');
                    insertVariableAtCursor(variable);
                });
            });
            
            // Set up save handlers based on component type
            if (type === 'text') {
                document.getElementById('save-text').addEventListener('click', () => {
                    const newContent = document.getElementById('text-content').value;
                    // Preserve newlines by replacing them with <br> tags
                    const formattedContent = newContent.replace(/\n/g, '<br>');
                    component.querySelector('.component-content').innerHTML = formattedContent;
                    updateComponentsArray();
                    showToast('Text updated successfully!');
                });
            } else if (type === 'image') {
                document.getElementById('save-image').addEventListener('click', () => {
                    const src = document.getElementById('image-src').value;
                    const alt = document.getElementById('image-alt').value;
                    const link = document.getElementById('image-link').value;
                    
                    let imageHtml = `<img src="${src}" alt="${alt}" style="max-width: 100%; height: auto;">`;
                    
                    if (link) {
                        imageHtml = `<a href="${link}">${imageHtml}</a>`;
                    }
                    
                    component.querySelector('.component-content').innerHTML = imageHtml;
                    updateComponentsArray();
                    showToast('Image updated successfully!');
                });
            } else if (type === 'button') {
                document.getElementById('save-button').addEventListener('click', () => {
                    const text = document.getElementById('button-text').value;
                    const link = document.getElementById('button-link').value;
                    const color = document.getElementById('button-color').value;
                    
                    const buttonHtml = `
                        <a href="${link}" style="display: inline-block; padding: 12px 24px; background-color: ${color}; color: white; text-decoration: none; border-radius: 4px;">${text}</a>
                    `;
                    
                    component.querySelector('.component-content').innerHTML = buttonHtml;
                    updateComponentsArray();
                    showToast('Button updated successfully!');
                });
            } else if (type === 'header') {
                document.getElementById('save-header').addEventListener('click', () => {
                    const title = document.getElementById('header-title').value;
                    const subtitle = document.getElementById('header-subtitle').value;
                    
                    const headerHtml = `
                        <div style="text-align: center; padding: 20px; background-color: #f8f9fa;">
                            <h1>${title}</h1>
                            <p>${subtitle}</p>
                        </div>
                    `;
                    
                    component.querySelector('.component-content').innerHTML = headerHtml;
                    updateComponentsArray();
                    showToast('Header updated successfully!');
                });
            } else if (type === 'hero') {
                document.getElementById('save-hero').addEventListener('click', () => {
                    const title = document.getElementById('hero-title').value;
                    const text = document.getElementById('hero-text').value;
                    
                    const heroHtml = `
                        <div style="text-align: center; padding: 40px; background-color: #e9ecef;">
                            <h2>${title}</h2>
                            <p>${text}</p>
                        </div>
                    `;
                    
                    component.querySelector('.component-content').innerHTML = heroHtml;
                    updateComponentsArray();
                    showToast('Hero section updated successfully!');
                });
            } else if (type === 'footer') {
                document.getElementById('save-footer').addEventListener('click', () => {
                    const text = document.getElementById('footer-text').value;
                    const contact = document.getElementById('footer-contact').value;
                    
                    const footerHtml = `
                        <div style="text-align: center; padding: 20px; background-color: #f5f5f5; margin-top: 20px;">
                            <p>${text}</p>
                            ${contact ? `<p>Contact: ${contact}</p>` : ''}
                        </div>
                    `;
                    
                    component.querySelector('.component-content').innerHTML = footerHtml;
                    updateComponentsArray();
                    showToast('Footer updated successfully!');
                });
            }
        }
        
        // Insert variable at cursor position in textarea
        function insertVariableAtCursor(variable) {
            const textarea = propertyEditor.querySelector('textarea');
            if (!textarea) return;
            
            const cursorPosition = textarea.selectionStart;
            const currentValue = textarea.value;
            
            // Insert the variable at cursor position
            textarea.value = currentValue.substring(0, cursorPosition) + 
                             variable + 
                             currentValue.substring(cursorPosition);
            
            // Set cursor position after the inserted variable
            textarea.selectionEnd = cursorPosition + variable.length;
            textarea.focus();
        }
        
        // Update the components array from the DOM
        function updateComponentsArray() {
            components = [];
            const componentElements = emailCanvas.querySelectorAll('.email-component');
            
            componentElements.forEach(element => {
                components.push({
                    type: element.dataset.type,
                    content: element.querySelector('.component-content').innerHTML
                });
            });
        }
        
        // Check if canvas is empty and show placeholder
        function checkEmptyCanvas() {
            if (emailCanvas.children.length === 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'canvas-placeholder';
                placeholder.innerHTML = '<p>Drag components from the left panel to build your email template</p>';
                emailCanvas.appendChild(placeholder);
            }
        }
        
        // Replace variables in content with their actual values
        function replaceVariables(content) {
            let processedContent = content;
            
            // Replace all variables in the content
            for (const [variableKey, variableName] of Object.entries(variableMap)) {
                const variableValue = variables[variableName] || variableKey;
                processedContent = processedContent.replace(
                    new RegExp(variableKey.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), 
                    variableValue
                );
            }
            
            return processedContent;
        }
        
        // Show preview modal
        function showPreview() {
            updateComponentsArray();
            
            if (components.length === 0) {
                showToast('Add some components to your email first!');
                return;
            }
            
            let previewHtml = '';
            
            components.forEach(component => {
                previewHtml += replaceVariables(component.content);
            });
            
            previewContent.innerHTML = previewHtml;
            previewModal.style.display = 'flex';
        }
        
        // Show export modal
        function showExportModal() {
            updateComponentsArray();
            
            if (components.length === 0) {
                showToast('Add some components to your email first!');
                return;
            }
            
            exportModal.style.display = 'flex';
            exportCodeContainer.style.display = 'none';
        }
        
        // Show send email modal
        function showSendModal() {
            updateComponentsArray();
            
            if (components.length === 0) {
                showToast('Add some components to your email first!');
                return;
            }
            
            // Pre-fill form with saved variables if available
            if (variables.recipientEmail) {
                sendToInput.value = variables.recipientEmail;
            }
            
            if (variables.senderName) {
                sendFromNameInput.value = variables.senderName;
            }
            
            // Clear status message
            sendStatus.style.display = 'none';
            sendStatus.innerHTML = '';
            
            sendModal.style.display = 'flex';
        }
        
        // Show variables modal
        function showVariablesModal() {
            variablesModal.style.display = 'flex';
        }
        
        // Save variables
        function saveVariables() {
            variables = {
                senderName: senderNameInput.value,
                senderEmail: senderEmailInput.value,
                recipientName: recipientNameInput.value,
                recipientEmail: recipientEmailInput.value,
                sendDate: sendDateInput.value,
                companyName: companyNameInput.value
            };
            
            // Save to localStorage
            localStorage.setItem('emailTemplateVariables', JSON.stringify(variables));
            
            // Show success message
            showToast('Variables saved successfully!');
            
            // Close modal after a short delay
            setTimeout(() => {
                variablesModal.style.display = 'none';
            }, 1000);
        }
        
        // Send email using EmailJS
        function sendEmail() {
            const toEmail = sendToInput.value.trim();
            const subject = sendSubjectInput.value.trim();
            const fromName = sendFromNameInput.value.trim();
            
            // Validate inputs
            if (!toEmail || !subject || !fromName) {
                showStatus('Please fill in all required fields', 'error');
                return;
            }
            
            if (!isValidEmail(toEmail)) {
                showStatus('Please enter a valid recipient email', 'error');
                return;
            }
            
            // Build email content
            updateComponentsArray();
            let emailHtml = '';
            
            components.forEach(component => {
                emailHtml += replaceVariables(component.content);
            });
            
            // Show sending status
            showStatus('Sending email...', 'loading');
            
            // Prepare email parameters
            const templateParams = {
                to_email: toEmail,
                subject: subject,
                from_name: fromName,
                message: emailHtml
            };
            
            // Send email using EmailJS
            // We use the "send" method instead of "sendForm" to send our custom HTML content
            emailjs.send('service_uz15s3l', 'template_q38w4mi', templateParams)
                .then(() => {
                    showStatus('Email sent successfully!', 'success');
                    
                    // Clear form after successful send
                    setTimeout(() => {
                        sendModal.style.display = 'none';
                    }, 2000);
                })
                .catch((error) => {
                    console.error('Email sending failed:', error);
                    showStatus('Failed to send email. Please try again.', 'error');
                });
        }
        
        // Show status message in send modal
        function showStatus(message, type) {
            sendStatus.style.display = 'block';
            sendStatus.innerHTML = '';
            
            const statusElement = document.createElement('div');
            
            if (type === 'loading') {
                statusElement.innerHTML = `<span class="status-loading"></span> ${message}`;
                statusElement.style.color = '#3498db';
            } else if (type === 'success') {
                statusElement.textContent = message;
                statusElement.style.color = '#2ecc71';
            } else if (type === 'error') {
                statusElement.textContent = message;
                statusElement.style.color = '#e74c3c';
            }
            
            sendStatus.appendChild(statusElement);
        }
        
        // Validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Export as HTML
        function exportAsHTML() {
            updateComponentsArray();
            
            let finalHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Email Template</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            max-width: 600px;
                            margin: 0 auto;
                            padding: 20px;
                        }
                        img {
                            max-width: 100%;
                            height: auto;
                        }
                        a {
                            color: #6e8efb;
                            text-decoration: none;
                        }
                    </style>
                </head>
                <body>
                
            `;
            
            components.forEach(component => {
                finalHtml += replaceVariables(component.content);
            });
            
            finalHtml += `
                </body>
                </html>
            `;
            
            exportCode.textContent = finalHtml;
            exportCodeContainer.style.display = 'block';
        }
        
        // Copy to clipboard
        function copyToClipboard() {
            updateComponentsArray();
            
            let finalHtml = '';
            
            components.forEach(component => {
                finalHtml += replaceVariables(component.content);
            });
            
            navigator.clipboard.writeText(finalHtml).then(() => {
                showToast('Copied to clipboard!');
            }).catch(err => {
                showToast('Failed to copy to clipboard');
                console.error('Could not copy text: ', err);
            });
        }
        
        // Show toast notification
        function showToast(message) {
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Initialize the app
        init();
    </script>
</body>
</html>
